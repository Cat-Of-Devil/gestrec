<!DOCTYPE HTML>
<html>
  <head>
    <title>Protractor Gesture Designer</title>
    <link rel="stylesheet" type="text/css" href="library.css">
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="protractor.min.js" charset="utf-8"></script>
    <script src="library.js" charset="utf-8"></script>
    <style>
body {
  font-family: Helvetica Neue;
  padding-top: 10px;
  padding-left: 0px;
  margin: 0;
}
#designer {
  position: fixed;
  top: 0;
  left: 0;
  padding-top: 10px;
  padding-left: 10px;
  padding-right: 10px;
  width: 400px;
}
#designer .controls {
  margin-bottom: 4px;
}
canvas {
  background: #f5f5f5;
  border: 1px solid #dedede;
}
#panel {
  margin-left: 430px;
}
#export {
  position: relative;
  padding-right: 20px;
}
#export .header {
  margin-bottom: 9px;
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 2px;
}
#export textarea {
  width: 100%;
  height: 600px;
  border: 1px solid #dedede;
}
#export .controls {
  position: absolute;
  right: 15px;
  top: -2px;
}
    </style>
  </head>
  <body>
    <div id="designer">
      <div class="controls">
        Mode: <select id="mode">
          <option value="train" selected>Train</option>
          <option value="test">Test</option>
          <option value="export">Export</option>
        </select>
      </div>
      <canvas id="canvas" width="400" height="400"></canvas>
      <br/>
      <div id="message"></div>
    </div>
    <div id="panel">
      <div id="library"></div>
      <div id="export" style="display: none;">
        <div class="header">
          Gesture Loader
          <div class="controls">
            <button id="load">Load</button>
          </div>
        </div>
        <textarea id="json"></textarea>
      </div>
    </div>
  </body>
  <script>
var THRESHOLD = 2;
var mode = "train";

function setMode(value) {
  mode = value;
  d3.select("#mode").property("value", mode);
  if (mode === "export") {
    d3.select("#library").style("display", "none");
    d3.select("#export").style("display", "block");
    d3.select("#json").property("value", lib.toJSON());
  } else {
    d3.select("#library").style("display", "block");
    d3.select("#export").style("display", "none");
  }
}

d3.select("#mode").on("change", function(evt) {
  var value = this.options[this.selectedIndex].value;
  d3.select("#message").text("");
  setMode(value);
});

d3.select("#load").on("click", function() {
  try {
    var json = d3.select("#json").property("value");
    lib.fromJSON(json).render();
    setMode("test");
  } catch (err) {
    alert(err);
  }
});

var lib = new GestureLibrary(d3.select("#library").node())
  .addEntry()
  .render();

var stroke = null;
var basetime = null;

var canvas = d3.select("#canvas").node();
var width = canvas.width;
var height = canvas.height;

function getXY(evt) {
  var rect = canvas.getBoundingClientRect();
  return {
    x: evt.clientX - rect.left,
    y: evt.clientY - rect.top
  };
}

d3.select("#canvas").on("mousedown", function() {
  if (mode === "export") return;
    
  // update gesture model
  var p = getXY(d3.event);
  basetime = Date.now();
  stroke = [new GesturePoint(p.x/width, p.y/height, 0)];
  GestureLibrary.drawPoints(canvas, stroke);
  
  // add listeners
  d3.select(window).on("mousemove", move).on("mouseup", up);
});

function move() {
  d3.event.preventDefault();

  // update gesture model
  var p = getXY(d3.event);
  stroke.push(new GesturePoint(p.x/width, p.y/height, Date.now() - basetime));

  // update canvas
  GestureLibrary.drawPoints(canvas, stroke);
}

function up() {
  d3.event.preventDefault();

  // update gesture model
  var gesture = new Gesture();
  gesture.addStroke(new GestureStroke(normalize(stroke)));
  
  if (mode === "train") {
    lib.addGesture(gesture).render();
  } else {
    var r = lib.recognize(gesture), msg = "None!";
    if (r.length && r[0].score > THRESHOLD) {
      msg = r[0].name + " (" + r[0].score.toFixed(2) + ")";
    }
    d3.select("#message").text("RECOGNIZE: " + msg);
  }
  basetime = null;
  stroke = null;

  // remove listeners
  d3.select(window).on("mousemove", null).on("mouseup", null);
  canvas.getContext("2d").clearRect(0, 0, width, height);
}

function normalize(points) {
  var xmin = Number.MAX_VALUE,
      ymin = Number.MAX_VALUE,
      xmax = 0,
      ymax = 0,
      len = points.length, i, dx, dy;
  
  for (i=0; i<len; ++i) {
    if (points[i].x < xmin) xmin = points[i].x;
    if (points[i].y < ymin) ymin = points[i].y;
    if (points[i].x > xmax) xmax = points[i].x;
    if (points[i].y > ymax) ymax = points[i].y;
  }

  dx = xmax - xmin;
  dy = ymax - ymin;
  if (dx > dy) {
    ymin -= (dx - dy) / 2;
    dy += (dx - dy);
  } else {
    xmin -= (dy - dx) / 2;
    dx += (dy - dx);
  }

  for (i=0; i<len; ++i) {
    points[i].x = 0.1 + 0.8 * (points[i].x - xmin) / dx;
    points[i].y = 0.1 + 0.8 * (points[i].y - ymin) / dy;
  }
  
  return points;
}
  </script>
</html>